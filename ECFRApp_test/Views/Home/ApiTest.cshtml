@{
    ViewData["Title"] = "API Test Page";
}

<div class="container mt-4">
    <h1 class="mb-4">ECFR API Test Page</h1>
    <p class="lead">Test all available API endpoints to read data from JSON files.</p>

    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">API Endpoints for Reading Stored Data</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Endpoint</th>
                                    <th>Description</th>
                                    <th>Source File</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>GET /api/ECFRData/snapshot</code></td>
                                    <td>Returns complete snapshot from ecfr_current.json</td>
                                    <td>Data/ecfr_current.json</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary test-btn" data-url="/api/ECFRData/snapshot">Test</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><code>GET /api/ECFRData/statistics</code></td>
                                    <td>Returns agency statistics from ecfr_current.json</td>
                                    <td>Data/ecfr_current.json (Statistics section)</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary test-btn" data-url="/api/ECFRData/statistics">Test</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><code>GET /api/ECFRData/historical</code></td>
                                    <td>Returns historical changes from ecfr_historical.json</td>
                                    <td>Data/ecfr_historical.json</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary test-btn" data-url="/api/ECFRData/historical">Test</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">API Response</h5>
                </div>
                <div class="card-body">
                    <div id="responseStatus" class="mb-2"></div>
                    <div id="responseMetadata" class="mb-3"></div>
                    <pre id="responseOutput" style="max-height: 500px; overflow-y: auto; background-color: #f5f5f5; padding: 15px; border-radius: 5px;"><code>Click "Test" button to see API response...</code></pre>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Quick Links</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Direct API Links (Open in new tab):</h6>
                            <ul>
                                <li><a href="/api/ECFRData/snapshot" target="_blank">View Snapshot JSON</a></li>
                                <li><a href="/api/ECFRData/statistics" target="_blank">View Statistics JSON</a></li>
                                <li><a href="/api/ECFRData/historical" target="_blank">View Historical JSON</a></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>UI Views:</h6>
                            <ul>
                                <li><a href="@Url.Action("Index", "DataViewer")">Data Viewer (Complete View)</a></li>
                                <li><a href="@Url.Action("Index", "Dashboard")">Dashboard (Statistics)</a></li>
                                <li><a href="@Url.Action("Historical", "Dashboard")">Historical Changes</a></li>
                                <li><a href="@Url.Action("Checksums", "Dashboard")">Checksums</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a href="@Url.Action("Index", "Home")" class="btn btn-secondary">Back to Home</a>
    </div>
</div>

@section Scripts {
    <script>
        document.querySelectorAll('.test-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const url = this.dataset.url;
                const status = document.getElementById('responseStatus');
                const metadata = document.getElementById('responseMetadata');
                const output = document.getElementById('responseOutput');
                
                // Reset
                status.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div> Loading...';
                metadata.innerHTML = '';
                output.innerHTML = '<code>Loading...</code>';
                
                try {
                    const startTime = performance.now();
                    const response = await fetch(url);
                    const endTime = performance.now();
                    const responseTime = (endTime - startTime).toFixed(2);
                    
                    const data = await response.json();
                    
                    // Status
                    if (response.ok) {
                        status.innerHTML = `<div class="alert alert-success mb-0">? Success - Status: ${response.status} ${response.statusText}</div>`;
                    } else {
                        status.innerHTML = `<div class="alert alert-danger mb-0">? Error - Status: ${response.status} ${response.statusText}</div>`;
                    }
                    
                    // Metadata
                    let metaInfo = `<strong>Response Time:</strong> ${responseTime}ms<br/>`;
                    metaInfo += `<strong>Content Type:</strong> ${response.headers.get('content-type')}<br/>`;
                    
                    // Count items
                    if (Array.isArray(data)) {
                        metaInfo += `<strong>Items:</strong> ${data.length}<br/>`;
                    } else if (data.documents) {
                        metaInfo += `<strong>Documents:</strong> ${data.documents.length}<br/>`;
                        metaInfo += `<strong>Statistics:</strong> ${data.statistics?.length || 0}<br/>`;
                    } else if (data.length !== undefined) {
                        metaInfo += `<strong>Items:</strong> ${data.length}<br/>`;
                    }
                    
                    metadata.innerHTML = `<div class="alert alert-info mb-0">${metaInfo}</div>`;
                    
                    // Format JSON
                    output.innerHTML = `<code>${JSON.stringify(data, null, 2)}</code>`;
                    
                } catch (error) {
                    status.innerHTML = `<div class="alert alert-danger mb-0">? Error: ${error.message}</div>`;
                    metadata.innerHTML = '';
                    output.innerHTML = `<code>Error occurred: ${error.message}</code>`;
                }
            });
        });
    </script>
}
